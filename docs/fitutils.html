<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.9.2" />
<title>isopytools.fitutils API documentation</title>
<meta name="description" content="Tools for adapting ISODISTORT outputs to DiffPy fits." />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>isopytools.fitutils</code></h1>
</header>
<section id="section-intro">
<p>Tools for adapting ISODISTORT outputs to DiffPy fits.</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#!/usr/bin/env python
##############################################################################
#
# isopytools            by Frandsen Group
#                     Benjamin A. Frandsen benfrandsen@byu.edu
#                     (c) 2022 Benjamin Allen Frandsen
#                     All rights reserved
#
# File coded by:    Benjamin Frandsen
#
# See AUTHORS.txt for a list of people who contributed.
# See LICENSE.txt for license information.
#
##############################################################################

&#34;&#34;&#34;Tools for adapting ISODISTORT outputs to DiffPy fits.
&#34;&#34;&#34;

from diffpy.srfit.fitbase.parameterset import ParameterSet
from collections import OrderedDict
import diffpy.structure.symmetryutilities as su
import diffpy.structure.spacegroups as sg
from isopytools.iso2diffpy import get_positions
import numpy as np
import sympy as sp

def getvars(fitnode):
    &#34;&#34;&#34;Return dictionary of variable names and values in srfit fit object.
    &#34;&#34;&#34;
    state = {p.name: p.value for p in fitnode}
    return state


def setvars(fitnode, state):
    &#34;&#34;&#34;Set fitnode variables according to their state dictionary.

    Skip any state items that are constrained.
    &#34;&#34;&#34;
    for n, v in dict(state).items():
        p = fitnode.get(n)
        p.setValue(v)
    return

def generate_constraints(iso):
    &#34;&#34;&#34;Generate general expressions for the position of each atom.
    
    Args:
        iso: IsoInfo instance from iso2diffpy
       
    Returns:
        Dictionary with coordinates of each atom expressed in terms of the
        deltas (which can in turn be expressed in terms of the mode
        amplitudes).
    &#34;&#34;&#34;
    names, coords = get_positions(iso, returnDict=False)
    sgobj = sg.GetSpaceGroup(iso.spacegroupnum)
    alltransformations = []
    uniqueidxs = []
    # go through list of symmetry operations once to sort out the duplicates
    for idx, name in enumerate(names):
        eqpos, symoplist, mult = su.expandPosition(sgobj, coords[idx])
        allpositions = []
        for sublist in symoplist:
            for symop in sublist:
                newposN = (np.dot(symop.R, coords[idx]) + symop.t) % 1
                allpositions.append(newposN)
        allpositions = np.round(np.array(allpositions), decimals=6)
        unique, idxs = np.unique(np.round(allpositions, decimals=4), axis=0, return_index=True)
        uniqueidxs.append(idxs)
    # now go through it again to apply the symmetry transformations to the mode shifts
    counter = 0
    for idx, name in enumerate(names):
        pos = sp.Matrix([iso.positions[name+&#39;_x&#39;][0],iso.positions[name+&#39;_y&#39;][0],iso.positions[name+&#39;_z&#39;][0]])
        eqpos, symoplist, mult = su.expandPosition(sgobj, coords[idx])
        partialtransformations = []
        for sublist in symoplist:
            for symop in sublist:
                Rmat = sp.Matrix(symop.R)
                tmat = sp.Matrix(symop.t)
                newpos = Rmat*pos + tmat
                partialtransformations.append(newpos)
        subset = [partialtransformations[i] for i in uniqueidxs[counter]]
        for vector in subset:
            for idx, element in enumerate(vector):
                try:
                    float(element)
                    vector[idx] = element % 1
                except TypeError:
                    pass

        alltransformations.append(subset)
        counter += 1
    # create a dictionary with the transformation constriants
    counter = 0
    transformed_positions = OrderedDict()
    for tr in alltransformations:
        for transformed_pos in tr:
            counter += 1
            transformed_positions[&#39;atom&#39;+str(counter)+&#39;_x&#39;] = str(transformed_pos[0])
            transformed_positions[&#39;atom&#39;+str(counter)+&#39;_y&#39;] = str(transformed_pos[1])
            transformed_positions[&#39;atom&#39;+str(counter)+&#39;_z&#39;] = str(transformed_pos[2])
    return transformed_positions

def loadmodes(fit,iso,phase):
    &#34;&#34;&#34;Turns symmetry mode amplitudes into fit variables.
    
    This function creates a ParameterSet consisting of the symmetry mode
    amplitudes, constrains the xyz positions of the atoms in relation to
    the mode amplitudes, and sets the amplitudes as fitting variables. The
    mode amplitude fitting variables are given the tag &#39;smd&#39;.
    
    Args:
        fit: diffpy.srfit FitRecipe instance
        iso: IsoInfo instance from iso2diffpy
        phase: diffpy.structure parameters generated from the structure
            that was added to the PDF contribution.
    &#34;&#34;&#34;
    smd = ParameterSet(&#39;smd&#39;)
    phase.addParameterSet(smd)
    for n, v in iso.modepars.items():
        smd.newParameter(n, v)
    for n, ev in iso.deltas.items():
        smd.newParameter(n, ev[-1])
        smd.constrain(n, ev[0])

    atoms = phase.getScatterers()
    transform_dict = generate_constraints(iso)
    for idx, (v, ev) in enumerate(transform_dict.items()):
        atomIdx, mod = divmod(idx, 3)
        if mod == 0:
            smd.constrain(atoms[atomIdx].x,ev)
        if mod == 1:
            smd.constrain(atoms[atomIdx].y,ev)
        if mod == 2:
            smd.constrain(atoms[atomIdx].z,ev)

    for pa in smd.iterPars(&#39;a\d+&#39;):
        fit.addVar(pa,tag=&#39;smd&#39;)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="isopytools.fitutils.generate_constraints"><code class="name flex">
<span>def <span class="ident">generate_constraints</span></span>(<span>iso)</span>
</code></dt>
<dd>
<div class="desc"><p>Generate general expressions for the position of each atom.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>iso</code></strong></dt>
<dd>IsoInfo instance from iso2diffpy</dd>
</dl>
<h2 id="returns">Returns</h2>
<p>Dictionary with coordinates of each atom expressed in terms of the
deltas (which can in turn be expressed in terms of the mode
amplitudes).</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def generate_constraints(iso):
    &#34;&#34;&#34;Generate general expressions for the position of each atom.
    
    Args:
        iso: IsoInfo instance from iso2diffpy
       
    Returns:
        Dictionary with coordinates of each atom expressed in terms of the
        deltas (which can in turn be expressed in terms of the mode
        amplitudes).
    &#34;&#34;&#34;
    names, coords = get_positions(iso, returnDict=False)
    sgobj = sg.GetSpaceGroup(iso.spacegroupnum)
    alltransformations = []
    uniqueidxs = []
    # go through list of symmetry operations once to sort out the duplicates
    for idx, name in enumerate(names):
        eqpos, symoplist, mult = su.expandPosition(sgobj, coords[idx])
        allpositions = []
        for sublist in symoplist:
            for symop in sublist:
                newposN = (np.dot(symop.R, coords[idx]) + symop.t) % 1
                allpositions.append(newposN)
        allpositions = np.round(np.array(allpositions), decimals=6)
        unique, idxs = np.unique(np.round(allpositions, decimals=4), axis=0, return_index=True)
        uniqueidxs.append(idxs)
    # now go through it again to apply the symmetry transformations to the mode shifts
    counter = 0
    for idx, name in enumerate(names):
        pos = sp.Matrix([iso.positions[name+&#39;_x&#39;][0],iso.positions[name+&#39;_y&#39;][0],iso.positions[name+&#39;_z&#39;][0]])
        eqpos, symoplist, mult = su.expandPosition(sgobj, coords[idx])
        partialtransformations = []
        for sublist in symoplist:
            for symop in sublist:
                Rmat = sp.Matrix(symop.R)
                tmat = sp.Matrix(symop.t)
                newpos = Rmat*pos + tmat
                partialtransformations.append(newpos)
        subset = [partialtransformations[i] for i in uniqueidxs[counter]]
        for vector in subset:
            for idx, element in enumerate(vector):
                try:
                    float(element)
                    vector[idx] = element % 1
                except TypeError:
                    pass

        alltransformations.append(subset)
        counter += 1
    # create a dictionary with the transformation constriants
    counter = 0
    transformed_positions = OrderedDict()
    for tr in alltransformations:
        for transformed_pos in tr:
            counter += 1
            transformed_positions[&#39;atom&#39;+str(counter)+&#39;_x&#39;] = str(transformed_pos[0])
            transformed_positions[&#39;atom&#39;+str(counter)+&#39;_y&#39;] = str(transformed_pos[1])
            transformed_positions[&#39;atom&#39;+str(counter)+&#39;_z&#39;] = str(transformed_pos[2])
    return transformed_positions</code></pre>
</details>
</dd>
<dt id="isopytools.fitutils.getvars"><code class="name flex">
<span>def <span class="ident">getvars</span></span>(<span>fitnode)</span>
</code></dt>
<dd>
<div class="desc"><p>Return dictionary of variable names and values in srfit fit object.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def getvars(fitnode):
    &#34;&#34;&#34;Return dictionary of variable names and values in srfit fit object.
    &#34;&#34;&#34;
    state = {p.name: p.value for p in fitnode}
    return state</code></pre>
</details>
</dd>
<dt id="isopytools.fitutils.loadmodes"><code class="name flex">
<span>def <span class="ident">loadmodes</span></span>(<span>fit, iso, phase)</span>
</code></dt>
<dd>
<div class="desc"><p>Turns symmetry mode amplitudes into fit variables.</p>
<p>This function creates a ParameterSet consisting of the symmetry mode
amplitudes, constrains the xyz positions of the atoms in relation to
the mode amplitudes, and sets the amplitudes as fitting variables. The
mode amplitude fitting variables are given the tag 'smd'.</p>
<h2 id="args">Args</h2>
<dl>
<dt><strong><code>fit</code></strong></dt>
<dd>diffpy.srfit FitRecipe instance</dd>
<dt><strong><code>iso</code></strong></dt>
<dd>IsoInfo instance from iso2diffpy</dd>
<dt><strong><code>phase</code></strong></dt>
<dd>diffpy.structure parameters generated from the structure
that was added to the PDF contribution.</dd>
</dl></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def loadmodes(fit,iso,phase):
    &#34;&#34;&#34;Turns symmetry mode amplitudes into fit variables.
    
    This function creates a ParameterSet consisting of the symmetry mode
    amplitudes, constrains the xyz positions of the atoms in relation to
    the mode amplitudes, and sets the amplitudes as fitting variables. The
    mode amplitude fitting variables are given the tag &#39;smd&#39;.
    
    Args:
        fit: diffpy.srfit FitRecipe instance
        iso: IsoInfo instance from iso2diffpy
        phase: diffpy.structure parameters generated from the structure
            that was added to the PDF contribution.
    &#34;&#34;&#34;
    smd = ParameterSet(&#39;smd&#39;)
    phase.addParameterSet(smd)
    for n, v in iso.modepars.items():
        smd.newParameter(n, v)
    for n, ev in iso.deltas.items():
        smd.newParameter(n, ev[-1])
        smd.constrain(n, ev[0])

    atoms = phase.getScatterers()
    transform_dict = generate_constraints(iso)
    for idx, (v, ev) in enumerate(transform_dict.items()):
        atomIdx, mod = divmod(idx, 3)
        if mod == 0:
            smd.constrain(atoms[atomIdx].x,ev)
        if mod == 1:
            smd.constrain(atoms[atomIdx].y,ev)
        if mod == 2:
            smd.constrain(atoms[atomIdx].z,ev)

    for pa in smd.iterPars(&#39;a\d+&#39;):
        fit.addVar(pa,tag=&#39;smd&#39;)</code></pre>
</details>
</dd>
<dt id="isopytools.fitutils.setvars"><code class="name flex">
<span>def <span class="ident">setvars</span></span>(<span>fitnode, state)</span>
</code></dt>
<dd>
<div class="desc"><p>Set fitnode variables according to their state dictionary.</p>
<p>Skip any state items that are constrained.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def setvars(fitnode, state):
    &#34;&#34;&#34;Set fitnode variables according to their state dictionary.

    Skip any state items that are constrained.
    &#34;&#34;&#34;
    for n, v in dict(state).items():
        p = fitnode.get(n)
        p.setValue(v)
    return</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="isopytools" href="index.html">isopytools</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="isopytools.fitutils.generate_constraints" href="#isopytools.fitutils.generate_constraints">generate_constraints</a></code></li>
<li><code><a title="isopytools.fitutils.getvars" href="#isopytools.fitutils.getvars">getvars</a></code></li>
<li><code><a title="isopytools.fitutils.loadmodes" href="#isopytools.fitutils.loadmodes">loadmodes</a></code></li>
<li><code><a title="isopytools.fitutils.setvars" href="#isopytools.fitutils.setvars">setvars</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.9.2</a>.</p>
</footer>
</body>
</html>